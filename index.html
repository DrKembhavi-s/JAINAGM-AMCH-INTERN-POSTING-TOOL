<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jain AGM Ayurvedic Medical College - Intern Postings Tool</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
padding: 20px;
}
.container {
max-width: 1400px;
margin: 0 auto;
background: white;
border-radius: 15px;
box-shadow: 0 20px 40px rgba(0,0,0,0.1);
}
.header {
background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
color: white;
text-align: center;
padding: 30px 20px;
border-radius: 15px 15px 0 0;
}
.header h1 { font-size: 2rem; margin-bottom: 10px; }
.main-content { padding: 30px; }
.login-section {
background: #e8f8ff;
border: 2px solid #3498db;
border-radius: 10px;
padding: 20px;
margin-bottom: 25px;
}
.login-form {
display: grid;
grid-template-columns: 1fr 1fr auto;
gap: 15px;
align-items: end;
}
.form-group { display: flex; flex-direction: column; }
label { font-weight: 600; color: #2c3e50; margin-bottom: 5px; }
input, select, textarea {
padding: 12px;
border: 2px solid #e1e8ed;
border-radius: 8px;
font-size: 1rem;
}
input:focus, select:focus, textarea:focus { outline: none; border-color: #3498db; }
.btn {
padding: 12px 25px;
border: none;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
font-size: 0.9rem;
transition: all 0.3s;
}
.btn-primary { background: #3498db; color: white; }
.btn-success { background: #27ae60; color: white; }
.btn-danger { background: #e74c3c; color: white; }
.btn-secondary { background: #95a5a6; color: white; }
.btn-warning { background: #f39c12; color: white; }
.btn-info { background: #17a2b8; color: white; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.section {
background: #f8f9fa;
border-radius: 10px;
padding: 25px;
margin-bottom: 25px;
border-left: 5px solid #3498db;
}
.section h2 { color: #2c3e50; margin-bottom: 20px; font-size: 1.5rem; }
.section h2::before { content: "‚ñ∂"; margin-right: 10px; color: #3498db; }
.form-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
margin-bottom: 20px;
}
.intern-list {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
gap: 20px;
margin-top: 20px;
}
.intern-card {
background: white;
border: 2px solid #e1e8ed;
border-radius: 10px;
padding: 20px;
transition: all 0.3s;
}
.intern-card:hover {
border-color: #3498db;
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}
.intern-name { font-weight: 700; color: #2c3e50; font-size: 1.1rem; }
.posting-item {
background: #f8f9fa;
border-radius: 6px;
padding: 10px;
margin: 8px 0;
border-left: 3px solid #3498db;
}
.action-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
.action-buttons .btn { padding: 8px 15px; font-size: 0.8rem; }
.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.5);
overflow-y: auto;
}
.modal-content {
background-color: white;
margin: 3% auto;
padding: 30px;
border-radius: 15px;
width: 90%;
max-width: 900px;
max-height: 85vh;
overflow-y: auto;
}
.close {
color: #aaa;
float: right;
font-size: 28px;
font-weight: bold;
cursor: pointer;
}
.close:hover { color: #000; }
.bulk-entry-row {
display: grid;
grid-template-columns: 50px 2fr 2fr 2fr auto;
gap: 10px;
align-items: center;
margin-bottom: 10px;
padding: 10px;
background: #f8f9fa;
border-radius: 5px;
}
.progress-bar {
background: #ecf0f1;
border-radius: 20px;
height: 20px;
margin: 10px 0;
overflow: hidden;
}
.progress-fill {
height: 100%;
background: linear-gradient(90deg, #27ae60, #2ecc71);
border-radius: 20px;
transition: width 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-weight: 600;
font-size: 0.8rem;
}
.dept-config-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
gap: 15px;
margin: 20px 0;
}
.dept-config-item {
background: #f8f9fa;
padding: 15px;
border-radius: 8px;
border: 2px solid #e1e8ed;
}
.dept-config-item.excluded {
background: #ffebee;
border-color: #e74c3c;
opacity: 0.7;
}
.dept-config-item label {
display: flex;
align-items: center;
gap: 10px;
cursor: pointer;
}
.dept-config-item input[type="checkbox"] {
width: 20px;
height: 20px;
cursor: pointer;
}
.dept-config-item input[type="number"] {
width: 80px;
padding: 5px;
margin-left: 10px;
}
.posting-editor-item {
background: #f8f9fa;
padding: 15px;
margin: 10px 0;
border-radius: 8px;
border-left: 4px solid #3498db;
}
.posting-editor-grid {
display: grid;
grid-template-columns: 2fr 1fr 1fr 1fr auto;
gap: 10px;
align-items: center;
}
@media (max-width: 768px) {
.form-grid, .login-form { grid-template-columns: 1fr; }
.intern-list { grid-template-columns: 1fr; }
.bulk-entry-row { grid-template-columns: 1fr; }
.posting-editor-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>JAIN AGM AYURVEDIC MEDICAL COLLEGE & HOSPITAL, VARUR</h1>
<p>SMART INTERN ROTATION & POSTINGS MANAGEMENT SYSTEM</p>
</div>

<div class="main-content">
<div id="adminLoginSection" class="login-section">
<h3 style="color: #3498db; margin-bottom: 15px;">üîê Admin Login</h3>
<div class="login-form">
<div class="form-group">
<label>Username</label>
<input type="text" id="adminUsername" placeholder="admin">
</div>
<div class="form-group">
<label>Password</label>
<input type="password" id="adminPassword" placeholder="password">
</div>
<button class="btn btn-primary" onclick="adminLogin()">Login</button>
</div>
<div id="adminError" style="color: #e74c3c; margin-top: 10px; display: none;"></div>
</div>

<div id="adminSections" style="display: none;">
<!-- Bulk Intern Entry -->
<div class="section">
<h2>üìã Bulk Intern Entry (Up to 60 Students)</h2>
<p style="color: #7f8c8d; margin-bottom: 15px;">Add multiple interns at once. Each intern will get an auto-generated rotation schedule.</p>
<div style="margin-bottom: 15px;">
<button class="btn btn-success" onclick="showBulkEntryModal()">+ Add Multiple Interns</button>
<button class="btn btn-primary" onclick="showSingleInternModal()">+ Add Single Intern</button>
<button class="btn btn-warning" onclick="generateAllRotations()">üîÑ Generate All Rotations</button>
</div>
<div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
<h4 style="color: #2c3e50; margin-bottom: 10px;">Quick Stats</h4>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
<div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
<div style="font-size: 2rem; font-weight: bold; color: #3498db;" id="totalInterns">0</div>
<div style="font-size: 0.9rem; color: #7f8c8d;">Total Interns</div>
</div>
<div style="text-align: center; padding: 15px; background: #e8f5e9; border-radius: 8px;">
<div style="font-size: 2rem; font-weight: bold; color: #27ae60;" id="completedInterns">0</div>
<div style="font-size: 0.9rem; color: #7f8c8d;">Completed (365d)</div>
</div>
<div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 8px;">
<div style="font-size: 2rem; font-weight: bold; color: #f39c12;" id="pendingInterns">0</div>
<div style="font-size: 0.9rem; color: #7f8c8d;">In Progress</div>
</div>
</div>
</div>
</div>

<!-- Manage Interns -->
<div class="section">
<h2>üë• Manage Interns & Postings</h2>
<input type="text" id="searchIntern" placeholder="üîç Search by name or registration number..." oninput="renderInterns()" style="width: 100%; max-width: 400px; margin-bottom: 20px;">
<div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
<button class="btn btn-success" onclick="exportAllData()">üíæ Export All Data</button>
<button class="btn btn-primary" onclick="importData()">üì• Import Data</button>
<input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
<button class="btn btn-primary" onclick="generateMasterChart()">üìä Master Chart (All Interns)</button>
<button class="btn btn-secondary" onclick="generateMasterCalendar()">üìÖ Master Calendar</button>
<button class="btn btn-warning" onclick="debugInterns()">üîç Debug Check</button>
</div>
<div class="intern-list" id="internList"></div>
</div>
</div>
</div>
</div>

<!-- Bulk Entry Modal -->
<div id="bulkEntryModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal('bulkEntryModal')">&times;</span>
<h2>üìã Bulk Intern Entry</h2>
<p style="color: #7f8c8d; margin-bottom: 20px;">Add up to 60 interns. Leave rows empty if you have fewer interns.</p>
<div style="margin-bottom: 20px;">
<button class="btn btn-primary" onclick="addBulkRows(10)">+ Add 10 Rows</button>
<button class="btn btn-secondary" onclick="clearBulkForm()">Clear All</button>
</div>
<div id="bulkEntryContainer" style="max-height: 400px; overflow-y: auto;"></div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" onclick="saveBulkInterns()">üíæ Save All Interns</button>
<button class="btn btn-secondary" onclick="closeModal('bulkEntryModal')">Cancel</button>
</div>
</div>
</div>

<!-- Single Intern Modal -->
<div id="singleInternModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal('singleInternModal')">&times;</span>
<h2>+ Add Single Intern</h2>
<div class="form-grid">
<div class="form-group">
<label>Intern Name *</label>
<input type="text" id="singleInternName">
</div>
<div class="form-group">
<label>Registration Number *</label>
<input type="text" id="singleInternRegNo">
</div>
<div class="form-group">
<label>Start Date *</label>
<input type="date" id="singleInternStartDate">
</div>
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-primary" onclick="saveSingleIntern()">Save Intern</button>
<button class="btn btn-secondary" onclick="closeModal('singleInternModal')">Cancel</button>
</div>
</div>
</div>

<!-- Department Configuration Modal -->
<div id="deptConfigModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal('deptConfigModal')">&times;</span>
<h2>‚öôÔ∏è Configure Rotation for <span id="configInternName"></span></h2>
<p style="color: #7f8c8d; margin: 15px 0;">Select departments to EXCLUDE (already completed) and specify partial completion if applicable.</p>
<div id="deptConfigInfo" style="background: #e8f8ff; padding: 15px; border-radius: 8px; margin: 15px 0;"></div>
<div class="dept-config-grid" id="deptConfigGrid"></div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" onclick="saveConfiguration()">üíæ Save Configuration</button>
<button class="btn btn-secondary" onclick="closeModal('deptConfigModal')">Cancel</button>
</div>
</div>
</div>

<!-- Manual Posting Editor Modal -->
<div id="postingEditorModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal('postingEditorModal')">&times;</span>
<h2>‚úèÔ∏è Edit Postings for <span id="editorInternName"></span></h2>
<div id="editorInternInfo" style="background: #e8f8ff; padding: 15px; border-radius: 8px; margin: 15px 0;"></div>
<div style="margin: 20px 0;">
<button class="btn btn-success" onclick="addNewPosting()">+ Add New Posting</button>
<button class="btn btn-warning" onclick="sortPostingsByDate()">üìÖ Sort by Date</button>
</div>
<div id="postingEditorList"></div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" onclick="savePostings()">üíæ Save All Changes</button>
<button class="btn btn-secondary" onclick="closeModal('postingEditorModal')">Cancel</button>
</div>
</div>
</div>

<!-- Add/Edit Posting Modal -->
<div id="addPostingModal" class="modal">
<div class="modal-content" style="max-width: 600px;">
<span class="close" onclick="closeModal('addPostingModal')">&times;</span>
<h2 id="addPostingTitle">Add New Posting</h2>
<div class="form-grid">
<div class="form-group">
<label>Department *</label>
<select id="postingDepartment">
<option value="">Select Department</option>
</select>
</div>
<div class="form-group">
<label>From Date *</label>
<input type="date" id="postingFromDate">
</div>
<div class="form-group">
<label>To Date *</label>
<input type="date" id="postingToDate">
</div>
<div class="form-group">
<label>Days (auto-calculated)</label>
<input type="number" id="postingDays" readonly style="background: #f0f0f0;">
</div>
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-primary" onclick="saveNewPosting()">Save Posting</button>
<button class="btn btn-secondary" onclick="closeModal('addPostingModal')">Cancel</button>
</div>
</div>
</div>

<!-- Department Letter Modal -->
<div id="departmentLetterModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal('departmentLetterModal')">&times;</span>
<h2>üìù Generate Department-Specific Posting Letter</h2>
<div id="departmentLetterInternInfo" style="background: #e8f8ff; padding: 15px; border-radius: 8px; margin: 20px 0;"></div>
<div class="form-group" style="margin: 20px 0;">
<label style="font-size: 1.1em; margin-bottom: 10px; display: block;">Select Department *</label>
<select id="departmentLetterSelect" style="width: 100%; padding: 12px; font-size: 1em;" onchange="updateDepartmentLetterPreview()">
<option value="">-- Select a Department --</option>
</select>
</div>
<div id="departmentLetterPreview" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; display: none;"></div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" onclick="generateDepartmentLetter()" id="generateDeptLetterBtn" disabled>üìÑ Generate Letter</button>
<button class="btn btn-secondary" onclick="closeModal('departmentLetterModal')">Cancel</button>
</div>
</div>
</div>

<script>
let interns = JSON.parse(localStorage.getItem('internData') || '[]');
let currentInternForConfig = null;
let currentInternForEditor = null;
let currentInternForDeptLetter = null;
let currentEditingPostingIndex = null;

const adminCreds = {
'admin': { password: 'admin2025', role: 'Administrator' },
'medsup': { password: 'ms2025', role: 'Medical Superintendent' },
'principal': { password: 'prin2025', role: 'Principal' }
};

// 19 Departments - IN-HOUSE: 1,2,4,6,7,9,11,13,14,15,16,17 | EXTERNAL: 3,5,8,10,12,18,19
const departments = [
{ name: 'KAYACHIKITSA', code: 'KC', days: 45, inHouse: true },
{ name: 'SHALYA TANTRA', code: 'ST', days: 30, inHouse: true },
{ name: 'SURGICAL HOSPITAL', code: 'SH', days: 15, inHouse: false },
{ name: 'SHALAKYA TANTRA', code: 'SKT', days: 15, inHouse: true },
{ name: 'AGARWAL EYE HOSPITAL', code: 'AEH', days: 15, inHouse: false },
{ name: 'PANCHAKARMA', code: 'PK', days: 35, inHouse: true },
{ name: 'PRASUTI TANTRA & STREE ROGA', code: 'PTSR', days: 15, inHouse: true },
{ name: 'MATERNITY HOSPITAL', code: 'MH', days: 15, inHouse: false },
{ name: 'KAUMARABHRITYA', code: 'KB', days: 15, inHouse: true },
{ name: 'SPARSHA PEDIATRIC HOSPITAL', code: 'SPH', days: 15, inHouse: false },
{ name: 'SWASTHAVRITTA', code: 'SW', days: 15, inHouse: true },
{ name: 'PHYSIOTHERAPY', code: 'PHYSIO', days: 15, inHouse: false },
{ name: 'ATYAYIKA', code: 'ATY', days: 15, inHouse: true },
{ name: 'AGADA TANTRA', code: 'AT', days: 15, inHouse: true },
{ name: 'LABORATORY', code: 'LAB', days: 15, inHouse: true },
{ name: 'PHARMACY', code: 'PHM', days: 15, inHouse: true },
{ name: 'SCREENING OPD', code: 'SCR', days: 15, inHouse: true },
{ name: 'CANCER HOSPITAL', code: 'CANC', days: 15, inHouse: false },
{ name: 'AYUSH', code: 'AYU', days: 30, inHouse: false }
];

function adminLogin() {
const user = document.getElementById('adminUsername').value.trim();
const pass = document.getElementById('adminPassword').value.trim();
const err = document.getElementById('adminError');

if (adminCreds[user] && adminCreds[user].password === pass) {
document.getElementById('adminLoginSection').style.display = 'none';
document.getElementById('adminSections').style.display = 'block';
interns = JSON.parse(localStorage.getItem('internData') || '[]');
console.log('Logged in. Interns loaded:', interns.length);
updateStats();
renderInterns();
} else {
err.textContent = '‚ùå Invalid credentials';
err.style.display = 'block';
}
}

function showBulkEntryModal() {
document.getElementById('bulkEntryModal').style.display = 'block';
clearBulkForm();
addBulkRows(10);
}

function showSingleInternModal() {
document.getElementById('singleInternModal').style.display = 'block';
document.getElementById('singleInternStartDate').valueAsDate = new Date();
}

function addBulkRows(count) {
const container = document.getElementById('bulkEntryContainer');
const currentRows = container.children.length;
const today = new Date().toISOString().split('T')[0];

for (let i = 0; i < count && currentRows + i < 60; i++) {
const row = document.createElement('div');
row.className = 'bulk-entry-row';
row.innerHTML = `
<div style="font-weight: bold; color: #2c3e50;">${currentRows + i + 1}</div>
<input type="text" placeholder="Enter intern name" class="bulk-name" style="padding: 10px; border: 2px solid #e1e8ed; border-radius: 5px;">
<input type="text" placeholder="Enter reg number" class="bulk-regno" style="padding: 10px; border: 2px solid #e1e8ed; border-radius: 5px;">
<input type="date" class="bulk-date" value="${today}" style="padding: 10px; border: 2px solid #e1e8ed; border-radius: 5px;">
<button class="btn btn-danger" onclick="this.parentElement.remove()" style="padding: 8px 12px;">√ó</button>
`;
container.appendChild(row);
}
}

function clearBulkForm() {
document.getElementById('bulkEntryContainer').innerHTML = '';
}

function saveBulkInterns() {
const rows = document.querySelectorAll('.bulk-entry-row');
let added = 0;
const errors = [];

rows.forEach((row, index) => {
const name = row.querySelector('.bulk-name').value.trim();
const regNo = row.querySelector('.bulk-regno').value.trim();
const startDate = row.querySelector('.bulk-date').value;

if (name && regNo && startDate) {
const dateTest = new Date(startDate);
if (isNaN(dateTest.getTime())) {
errors.push(`Row ${index + 1}: Invalid date format`);
return;
}

if (interns.some(i => i.regNo === regNo)) {
errors.push(`Row ${index + 1}: Registration number "${regNo}" already exists`);
} else {
interns.push({
id: 'intern_' + Date.now() + '_' + Math.floor(Math.random() * 10000),
name,
regNo,
startDate,
postings: [],
totalDays: 0,
rotationGenerated: false,
excludedDepts: [],
partialDepts: {},
resumeFromDate: null,
completedDays: 0
});
added++;
}
} else if (name || regNo || startDate) {
errors.push(`Row ${index + 1}: Please fill all fields`);
}
});

if (errors.length > 0) {
alert('‚ö†Ô∏è Some issues found:\n\n' + errors.join('\n'));
}

if (added > 0) {
localStorage.setItem('internData', JSON.stringify(interns));
updateStats();
renderInterns();
closeModal('bulkEntryModal');
clearBulkForm();
alert(`‚úÖ Successfully added ${added} interns!${errors.length > 0 ? '\n\nNote: ' + errors.length + ' rows had issues' : ''}\n\nNext: Configure each intern's excluded departments if needed.`);
} else {
if (errors.length === 0) {
alert('‚ö†Ô∏è No valid data found.');
}
}
}

function saveSingleIntern() {
const name = document.getElementById('singleInternName').value.trim();
const regNo = document.getElementById('singleInternRegNo').value.trim();
const startDate = document.getElementById('singleInternStartDate').value;

if (!name || !regNo || !startDate) {
alert('‚ö†Ô∏è Please fill all fields');
return;
}

if (interns.some(i => i.regNo === regNo)) {
alert('‚ö†Ô∏è Registration number already exists');
return;
}

interns.push({
id: 'intern_' + Date.now() + '_' + Math.floor(Math.random() * 10000),
name, regNo, startDate,
postings: [],
totalDays: 0,
rotationGenerated: false,
excludedDepts: [],
partialDepts: {},
resumeFromDate: null,
completedDays: 0
});

localStorage.setItem('internData', JSON.stringify(interns));
document.getElementById('singleInternName').value = '';
document.getElementById('singleInternRegNo').value = '';
updateStats();
renderInterns();
closeModal('singleInternModal');
alert('‚úÖ Intern added successfully!');
}

function showDeptConfigModal(internId) {
const intern = interns.find(i => i.id === internId);
if (!intern) return;

currentInternForConfig = intern;
document.getElementById('configInternName').textContent = intern.name;
document.getElementById('deptConfigInfo').innerHTML = `
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
<div><strong>Registration No:</strong> ${intern.regNo}</div>
<div><strong>Start Date:</strong> ${new Date(intern.startDate).toLocaleDateString('en-GB')}</div>
</div>
`;

const grid = document.getElementById('deptConfigGrid');
grid.innerHTML = '';

departments.forEach((dept, index) => {
const isExcluded = intern.excludedDepts && intern.excludedDepts.includes(dept.name);
const partialDays = intern.partialDepts && intern.partialDepts[dept.name] || 0;

const item = document.createElement('div');
item.className = 'dept-config-item' + (isExcluded ? ' excluded' : '');
item.innerHTML = `
<label>
<input type="checkbox" class="dept-exclude-cb" data-dept="${dept.name}" ${isExcluded ? 'checked' : ''} onchange="toggleDeptExclude(this)">
<div>
<strong>${dept.code} - ${dept.name}</strong>
<div style="font-size: 0.85em; color: #7f8c8d;">${dept.days} days total ${dept.inHouse ? '(In-house)' : '(External)'}</div>
<div style="margin-top: 5px;">
<label style="font-size: 0.85em;">Days completed:
<input type="number" class="dept-partial-input" data-dept="${dept.name}" value="${partialDays}" min="0" max="${dept.days}" style="width: 60px; padding: 3px;">
/ ${dept.days}</label>
</div>
</div>
</label>
`;
grid.appendChild(item);
});

document.getElementById('deptConfigModal').style.display = 'block';
}

function toggleDeptExclude(checkbox) {
const item = checkbox.closest('.dept-config-item');
if (checkbox.checked) {
item.classList.add('excluded');
} else {
item.classList.remove('excluded');
}
}

function saveConfiguration() {
console.log('saveConfiguration called');
console.log('currentInternForConfig:', currentInternForConfig);
    
if (!currentInternForConfig) {
alert('‚ö†Ô∏è Error: No intern selected for configuration');
return;
}

const excludedDepts = [];
const partialDepts = {};

// Collect excluded departments (fully completed)
document.querySelectorAll('.dept-exclude-cb').forEach(cb => {
if (cb.checked) {
excludedDepts.push(cb.dataset.dept);
console.log('Excluded department:', cb.dataset.dept);
}
});

// Collect partial completions (ONLY for non-excluded departments)
document.querySelectorAll('.dept-partial-input').forEach(input => {
const days = parseInt(input.value) || 0;
const deptName = input.dataset.dept;
        
// Only count partial days if department is NOT excluded
if (days > 0 && !excludedDepts.includes(deptName)) {
partialDepts[deptName] = days;
console.log('Partial department:', deptName, '=', days, 'days');
}
});

// Calculate total completed days
let totalCompletedDays = 0;

// Add days from fully excluded departments
excludedDepts.forEach(deptName => {
const dept = departments.find(d => d.name === deptName);
if (dept) {
console.log(`Adding ${dept.days} days from excluded ${deptName}`);
totalCompletedDays += dept.days;
}
});

// Add days from partially completed departments
Object.keys(partialDepts).forEach(deptName => {
console.log(`Adding ${partialDepts[deptName]} days from partial ${deptName}`);
totalCompletedDays += partialDepts[deptName];
});

console.log('Total completed days calculated:', totalCompletedDays);

// Calculate resume date = start date + completed days
const startDate = new Date(currentInternForConfig.startDate);
const calculatedResumeDate = new Date(startDate);
calculatedResumeDate.setDate(calculatedResumeDate.getDate() + totalCompletedDays);
    
const resumeFromDate = calculatedResumeDate.toISOString().split('T')[0];
console.log('Auto-calculated resume date:', resumeFromDate);

// Update the intern object
const internIndex = interns.findIndex(i => i.id === currentInternForConfig.id);
    
if (internIndex === -1) {
alert('‚ö†Ô∏è Error: Could not find intern in array');
return;
}

// Update the intern
interns[internIndex].excludedDepts = excludedDepts;
interns[internIndex].partialDepts = partialDepts;
interns[internIndex].resumeFromDate = resumeFromDate;
interns[internIndex].completedDays = totalCompletedDays;

// Save to localStorage
localStorage.setItem('internData', JSON.stringify(interns));
interns = JSON.parse(localStorage.getItem('internData') || '[]');

closeModal('deptConfigModal');
renderInterns();

alert(`‚úÖ Configuration saved!

Excluded departments: ${excludedDepts.length}
Partial completions: ${Object.keys(partialDepts).length}
Total completed days: ${totalCompletedDays}
Remaining days: ${365 - totalCompletedDays}

Resume from: ${new Date(resumeFromDate).toLocaleDateString('en-GB')}
Calculation: ${currentInternForConfig.startDate} + ${totalCompletedDays} days`);
}

function showPostingEditor(internId) {
const intern = interns.find(i => i.id === internId);
if (!intern) return;

currentInternForEditor = intern;
document.getElementById('editorInternName').textContent = intern.name;
document.getElementById('editorInternInfo').innerHTML = `
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
<div><strong>Registration No:</strong> ${intern.regNo}</div>
<div><strong>Start Date:</strong> ${new Date(intern.startDate).toLocaleDateString('en-GB')}</div>
<div><strong>Total Days:</strong> ${intern.totalDays}/365</div>
</div>
`;

renderPostingEditor();
document.getElementById('postingEditorModal').style.display = 'block';
}

function renderPostingEditor() {
if (!currentInternForEditor) return;

const list = document.getElementById('postingEditorList');
if (!currentInternForEditor.postings || currentInternForEditor.postings.length === 0) {
list.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No postings yet. Click "Add New Posting" to start.</p>';
return;
}

list.innerHTML = currentInternForEditor.postings.map((posting, index) => {
const dept = departments.find(d => d.name === posting.department);
return `
<div class="posting-editor-item">
<div class="posting-editor-grid">
<div>
<strong>${dept ? dept.code : 'N/A'} - ${posting.department}</strong>
<div style="font-size: 0.85em; color: #7f8c8d;">${posting.days} days</div>
</div>
<div>
<strong>From:</strong><br>
${new Date(posting.fromDate).toLocaleDateString('en-GB')}
</div>
<div>
<strong>To:</strong><br>
${new Date(posting.toDate).toLocaleDateString('en-GB')}
</div>
<div style="text-align: center;">
<strong>Days:</strong><br>
${posting.days}
</div>
<div style="display: flex; gap: 5px;">
<button class="btn btn-primary" onclick="editPosting(${index})" style="padding: 5px 10px; font-size: 0.8em;">‚úèÔ∏è</button>
<button class="btn btn-danger" onclick="deletePosting(${index})" style="padding: 5px 10px; font-size: 0.8em;">üóëÔ∏è</button>
</div>
</div>
</div>
`}).join('');
}

function addNewPosting() {
currentEditingPostingIndex = null;
document.getElementById('addPostingTitle').textContent = 'Add New Posting';

const select = document.getElementById('postingDepartment');
select.innerHTML = '<option value="">Select Department</option>';
departments.forEach(dept => {
select.innerHTML += `<option value="${dept.name}">${dept.code} - ${dept.name} (${dept.days} days)</option>`;
});

document.getElementById('postingFromDate').value = '';
document.getElementById('postingToDate').value = '';
document.getElementById('postingDays').value = '';
document.getElementById('addPostingModal').style.display = 'block';
}

function editPosting(index) {
if (!currentInternForEditor) return;

currentEditingPostingIndex = index;
const posting = currentInternForEditor.postings[index];

document.getElementById('addPostingTitle').textContent = 'Edit Posting';

const select = document.getElementById('postingDepartment');
select.innerHTML = '<option value="">Select Department</option>';
departments.forEach(dept => {
const selected = dept.name === posting.department ? 'selected' : '';
select.innerHTML += `<option value="${dept.name}" ${selected}>${dept.code} - ${dept.name} (${dept.days} days)</option>`;
});

document.getElementById('postingFromDate').value = posting.fromDate;
document.getElementById('postingToDate').value = posting.toDate;
document.getElementById('postingDays').value = posting.days;
document.getElementById('addPostingModal').style.display = 'block';
}

function deletePosting(index) {
if (!currentInternForEditor) return;

if (confirm('Delete this posting?')) {
currentInternForEditor.postings.splice(index, 1);
currentInternForEditor.totalDays = currentInternForEditor.postings.reduce((sum, p) => sum + p.days, 0);
renderPostingEditor();
}
}

function saveNewPosting() {
const deptName = document.getElementById('postingDepartment').value;
const fromDate = document.getElementById('postingFromDate').value;
const toDate = document.getElementById('postingToDate').value;

if (!deptName || !fromDate || !toDate) {
alert('Please fill all fields');
return;
}

const from = new Date(fromDate);
const to = new Date(toDate);
const days = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;

if (days <= 0) {
alert('To Date must be after From Date');
return;
}

const posting = {
id: Date.now() + Math.random(),
department: deptName,
fromDate,
toDate,
days
};

if (currentEditingPostingIndex !== null) {
currentInternForEditor.postings[currentEditingPostingIndex] = posting;
} else {
currentInternForEditor.postings.push(posting);
}

currentInternForEditor.totalDays = currentInternForEditor.postings.reduce((sum, p) => sum + p.days, 0);
renderPostingEditor();
closeModal('addPostingModal');
}

document.getElementById('postingFromDate').addEventListener('change', calculateDays);
document.getElementById('postingToDate').addEventListener('change', calculateDays);

function calculateDays() {
const fromDate = document.getElementById('postingFromDate').value;
const toDate = document.getElementById('postingToDate').value;

if (fromDate && toDate) {
const from = new Date(fromDate);
const to = new Date(toDate);
const days = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;
document.getElementById('postingDays').value = days > 0 ? days : 0;
}
}

function sortPostingsByDate() {
if (!currentInternForEditor) return;

currentInternForEditor.postings.sort((a, b) => new Date(a.fromDate) - new Date(b.fromDate));
renderPostingEditor();
alert('‚úÖ Postings sorted by date');
}

function savePostings() {
if (!currentInternForEditor) return;

localStorage.setItem('internData', JSON.stringify(interns));
closeModal('postingEditorModal');
renderInterns();
alert('‚úÖ All postings saved!');
}

function generateAllRotations() {
if (interns.length === 0) {
alert('‚ö†Ô∏è Please add interns first');
return;
}

const internsToGenerate = interns.filter(i => !i.rotationGenerated || i.postings.length === 0);

if (internsToGenerate.length === 0) {
alert('‚ÑπÔ∏è All interns already have rotations generated!\n\nTo regenerate, delete their postings using the Edit Postings button.');
return;
}

if (!confirm(`üîÑ Generate automatic rotations for ${internsToGenerate.length} interns?\n\n‚úì Until Dec 2025: In-house only\n‚úì From Jan 2026: Evenly distributed (in-house + external)\n‚úì Respects excluded departments\n‚úì Handles partial completions\n‚úì Uses "Resume From" date if set\n\nProceed?`)) {
return;
}

const JAN_2026 = new Date('2026-01-01');
let generatedCount = 0;

internsToGenerate.forEach((intern, internIndex) => {
// Use resumeFromDate if set, otherwise use startDate
const effectiveStartDate = intern.resumeFromDate ? 
new Date(intern.resumeFromDate) : 
new Date(intern.startDate);

if (isNaN(effectiveStartDate.getTime())) {
alert(`‚ö†Ô∏è Invalid date for ${intern.name}`);
return;
}

console.log(`Generating for ${intern.name}: Start=${intern.startDate}, Resume=${intern.resumeFromDate || 'N/A'}, Using=${effectiveStartDate.toISOString().split('T')[0]}`);

let currentDate = new Date(effectiveStartDate);
intern.postings = [];

const excludedDepts = intern.excludedDepts || [];
const partialDepts = intern.partialDepts || {};

// Calculate how many days are already completed
const completedDays = intern.completedDays || 0;
const remainingDays = 365 - completedDays;
        
console.log(`Completed: ${completedDays} days, Remaining: ${remainingDays} days`);

// Filter available departments
const inHouseDepts = departments.filter(d => {
if (!d.inHouse) return false;
if (excludedDepts.includes(d.name)) return false;
            
// Check if partially completed
const partialDays = partialDepts[d.name] || 0;
const remainingDeptDays = d.days - partialDays;
            
return remainingDeptDays > 0;
});

const externalDepts = departments.filter(d => {
if (d.inHouse) return false;
if (excludedDepts.includes(d.name)) return false;
            
const partialDays = partialDepts[d.name] || 0;
const remainingDeptDays = d.days - partialDays;
            
return remainingDeptDays > 0;
});

console.log(`Available: ${inHouseDepts.length} in-house, ${externalDepts.length} external`);

// PHASE 1: Until end of December 2025 - Only in-house
const shuffledInHouse = shuffleWithOffset([...inHouseDepts], internIndex);
        
for (let dept of shuffledInHouse) {
if (currentDate >= JAN_2026) break;

const completedDays = partialDepts[dept.name] || 0;
let daysToSchedule = dept.days - completedDays;

if (daysToSchedule <= 0) continue;

// Check if posting would extend into 2026
const testEndDate = new Date(currentDate);
testEndDate.setDate(testEndDate.getDate() + daysToSchedule - 1);

if (testEndDate >= JAN_2026) {
// Calculate days remaining in 2025
const dec31_2025 = new Date('2025-12-31');
const daysUntilNewYear = Math.ceil((dec31_2025 - currentDate) / (1000 * 60 * 60 * 24)) + 1;

if (daysUntilNewYear >= 7) {
daysToSchedule = Math.min(daysToSchedule, daysUntilNewYear);
} else {
break;
}
}

const fromDate = new Date(currentDate);
const toDate = new Date(currentDate);
toDate.setDate(toDate.getDate() + daysToSchedule - 1);

intern.postings.push({
id: Date.now() + internIndex * 10000 + intern.postings.length * 100 + Math.random(),
department: dept.name,
fromDate: fromDate.toISOString().split('T')[0],
toDate: toDate.toISOString().split('T')[0],
days: daysToSchedule
});

currentDate.setDate(currentDate.getDate() + daysToSchedule);
}

// PHASE 2: From Jan 2026 onwards - Mix in-house and external
const remainingInHouse = shuffledInHouse.filter(dept => {
const alreadyScheduled = intern.postings.some(p => p.department === dept.name);
const completedDays = partialDepts[dept.name] || 0;
const scheduledDays = alreadyScheduled ? 
intern.postings.find(p => p.department === dept.name).days : 0;
const remainingDays = dept.days - completedDays - scheduledDays;
            
return remainingDays > 0;
});

const shuffledExternal = shuffleWithOffset([...externalDepts], internIndex);
const phase2Depts = [];

// Interleave in-house and external
const maxLength = Math.max(remainingInHouse.length, shuffledExternal.length);
for (let i = 0; i < maxLength; i++) {
if (i < remainingInHouse.length) phase2Depts.push(remainingInHouse[i]);
if (i < shuffledExternal.length) phase2Depts.push(shuffledExternal[i]);
}

phase2Depts.forEach(dept => {
const completedDays = partialDepts[dept.name] || 0;
const existingPosting = intern.postings.find(p => p.department === dept.name);
const scheduledDays = existingPosting ? existingPosting.days : 0;
            
let daysToSchedule = dept.days - completedDays - scheduledDays;

if (daysToSchedule <= 0) return;

const fromDate = new Date(currentDate);
const toDate = new Date(currentDate);
toDate.setDate(toDate.getDate() + daysToSchedule - 1);

intern.postings.push({
id: Date.now() + internIndex * 10000 + intern.postings.length * 100 + Math.random(),
department: dept.name,
fromDate: fromDate.toISOString().split('T')[0],
toDate: toDate.toISOString().split('T')[0],
days: daysToSchedule
});

currentDate.setDate(currentDate.getDate() + daysToSchedule);
});

intern.totalDays = intern.postings.reduce((sum, p) => sum + p.days, 0);
intern.rotationGenerated = true;
generatedCount++;

console.log(`‚úì ${intern.name}: ${intern.postings.length} postings, ${intern.totalDays} days total`);
});

localStorage.setItem('internData', JSON.stringify(interns));
interns = JSON.parse(localStorage.getItem('internData') || '[]');

updateStats();
renderInterns();

alert(`‚úÖ SUCCESS! Generated rotations for ${generatedCount} interns!

üìä Features:
‚Ä¢ Until Dec 2025: In-house only
‚Ä¢ From Jan 2026: Evenly distributed
‚Ä¢ Excluded completed departments
‚Ä¢ Handled partial completions
‚Ä¢ Used "Resume From" dates where set
‚Ä¢ All 19 departments covered`);
}

function shuffleWithOffset(array, offset) {
const result = [...array];
const rotate = offset % array.length;
return [...result.slice(rotate), ...result.slice(0, rotate)];
}

function renderInterns() {
const search = document.getElementById('searchIntern').value.toLowerCase();
const filtered = interns.filter(i => 
i.name.toLowerCase().includes(search) || i.regNo.toLowerCase().includes(search)
);

document.getElementById('internList').innerHTML = filtered.map(intern => {
const progress = (intern.totalDays / 365) * 100;
const hasConfig = intern.excludedDepts && (intern.excludedDepts.length > 0 || Object.keys(intern.partialDepts || {}).length > 0);
const hasResumeDate = intern.resumeFromDate;
const internIdSafe = String(intern.id).replace(/'/g, "\\'");

return `
<div class="intern-card">
<div class="intern-name">${intern.name}</div>
<div style="color: #7f8c8d; margin-bottom: 10px;">
Reg: ${intern.regNo} | Start: ${new Date(intern.startDate).toLocaleDateString('en-GB')}
${hasResumeDate ? `<br>üìÖ Resume from: ${new Date(intern.resumeFromDate).toLocaleDateString('en-GB')}` : ''}
${hasConfig ? `<br>‚úÖ Completed: ${intern.completedDays || 0} days` : ''}
</div>
${hasConfig ? '<div style="color: #27ae60; font-size: 0.85em; margin-bottom: 5px;">‚öôÔ∏è Custom configuration applied</div>' : ''}
<div class="progress-bar">
<div class="progress-fill" style="width: ${Math.min(progress, 100)}%">
${Math.round(progress)}%
</div>
</div>
<div style="margin: 10px 0;">
<strong>Days:</strong> ${intern.totalDays}/365 |
<strong>Depts:</strong> ${intern.postings.length}/19
${intern.rotationGenerated ? '<span style="color: #27ae60;">‚úì Auto-Generated</span>' : ''}
</div>
<div style="max-height: 150px; overflow-y: auto;">
${intern.postings.slice(0, 5).map(p => `
<div class="posting-item">
<strong>${p.department}</strong><br>
<small>${new Date(p.fromDate).toLocaleDateString('en-GB')} - ${new Date(p.toDate).toLocaleDateString('en-GB')}</small>
<small style="color: #27ae60; display: block;">${p.days} days</small>
</div>
`).join('')}
${intern.postings.length > 5 ? `<div style="text-align: center; color: #7f8c8d; font-size: 0.9em;">+ ${intern.postings.length - 5} more</div>` : ''}
</div>
<div class="action-buttons">
<button class="btn btn-info" onclick="handleConfigureClick('${internIdSafe}')">‚öôÔ∏è Configure</button>
<button class="btn btn-warning" onclick="handleEditClick('${internIdSafe}')">‚úèÔ∏è Edit Postings</button>
<button class="btn btn-primary" onclick="handleChartClick('${internIdSafe}')">üìä Chart</button>
<button class="btn btn-success" onclick="handleCalendarClick('${internIdSafe}')">üìÖ Calendar</button>
<button class="btn btn-secondary" onclick="handleLetterClick('${internIdSafe}')">üìù Letter</button>
<button class="btn btn-danger" onclick="handleDeleteClick('${internIdSafe}')">üóëÔ∏è Delete</button>
</div>
</div>
`}).join('');
}

// Button click handlers
function handleConfigureClick(internId) {
console.log('Configure clicked for:', internId);
showDeptConfigModal(internId);
}

function handleEditClick(internId) {
console.log('Edit clicked for:', internId);
showPostingEditor(internId);
}

function handleChartClick(internId) {
console.log('Chart clicked for:', internId);
generateIndividualChart(internId);
}

function handleCalendarClick(internId) {
console.log('Calendar clicked for:', internId);
generateCalendar(internId);
}

function handleLetterClick(internId) {
console.log('Letter clicked for:', internId);
showDepartmentLetterModal(internId);
}

function handleDeleteClick(internId) {
console.log('Delete clicked for:', internId);
deleteIntern(internId);
}

function generateIndividualChart(internId) {
const intern = interns.find(i => i.id === internId);
if (!intern || !intern.postings.length) {
alert('‚ö†Ô∏è No postings found');
return;
}

const html = generateChartHTML([intern], false);
downloadFile(html, `Individual_Chart_${intern.name.replace(/\s/g, '_')}.html`);
alert('‚úÖ Chart downloaded!');
}

function generateMasterChart() {
if (!interns.length || !interns.some(i => i.postings.length)) {
alert('‚ö†Ô∏è No interns with postings found');
return;
}

const html = generateChartHTML(interns.filter(i => i.postings.length), true);
downloadFile(html, `Master_Chart_${new Date().toISOString().split('T')[0]}.html`);
alert('‚úÖ Master chart generated!');
}

function generateChartHTML(internsList, isMaster) {
let html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>${isMaster ? 'Master Posting Chart' : 'Individual Posting Chart'}</title>
<style>
body { font-family: Arial; padding: 30px; }
h1, h2 { text-align: center; color: #2c3e50; }
table { width: 100%; border-collapse: collapse; margin: 20px 0; page-break-inside: avoid; }
th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9em; }
th { background: #3498db; color: white; font-weight: 600; }
.dept-code { background: #e3f2fd; padding: 3px 8px; border-radius: 3px; font-weight: 600; }
@media print { .no-print { display: none; } }
</style></head><body>
<h1>JAIN AGM AYURVEDIC MEDICAL COLLEGE & HOSPITAL, VARUR</h1>
<h2>${isMaster ? 'MASTER POSTING CHART' : 'INDIVIDUAL POSTING CHART'}</h2>
<p style="text-align: center; color: #7f8c8d;">Generated: ${new Date().toLocaleDateString('en-GB')} at ${new Date().toLocaleTimeString()}</p>`;

internsList.forEach(intern => {
html += `
<div style="margin: 30px 0; page-break-inside: avoid;">
<h3 style="background: #3498db; color: white; padding: 15px; border-radius: 8px;">
${intern.name} (${intern.regNo}) - Start Date: ${new Date(intern.startDate).toLocaleDateString('en-GB')}
</h3>
<table>
<thead>
<tr>
<th style="width: 50px;">S.No</th>
<th>Department</th>
<th>Code</th>
<th>From Date</th>
<th>To Date</th>
<th>Days</th>
</tr>
</thead>
<tbody>`;

intern.postings.forEach((posting, pIdx) => {
const dept = departments.find(d => d.name === posting.department);
html += `
<tr>
<td style="text-align: center;">${pIdx + 1}</td>
<td><strong>${posting.department}</strong></td>
<td><span class="dept-code">${dept ? dept.code : 'N/A'}</span></td>
<td>${new Date(posting.fromDate).toLocaleDateString('en-GB')}</td>
<td>${new Date(posting.toDate).toLocaleDateString('en-GB')}</td>
<td style="text-align: center; font-weight: 600;">${posting.days}</td>
</tr>`;
});

html += `
<tr style="background: #f8f9fa; font-weight: bold;">
<td colspan="5" style="text-align: right;">TOTAL DAYS:</td>
<td style="text-align: center; color: ${intern.totalDays >= 365 ? '#27ae60' : '#e74c3c'};">${intern.totalDays}/365</td>
</tr>
</tbody>
</table>
</div>`;
});

html += `
<div style="text-align: center; margin-top: 40px; padding: 20px; background: #ecf0f1; border-radius: 10px;">
<p style="font-weight: bold;">OFFICIAL DOCUMENT - JAIN AGM AYURVEDIC MEDICAL COLLEGE</p>
</div>
</body></html>`;

return html;
}

function generateCalendar(internId) {
const intern = interns.find(i => i.id === internId);
if (!intern || !intern.postings.length) {
alert('‚ö†Ô∏è No postings found');
return;
}

const html = generateCalendarHTML([intern]);
downloadFile(html, `Calendar_${intern.name.replace(/\s/g, '_')}.html`);
alert('‚úÖ Calendar generated!');
}

function generateMasterCalendar() {
if (!interns.length || !interns.some(i => i.postings.length)) {
alert('‚ö†Ô∏è No interns with postings');
return;
}

const html = generateCalendarHTML(interns.filter(i => i.postings.length));
downloadFile(html, `Master_Calendar_${new Date().toISOString().split('T')[0]}.html`);
alert('‚úÖ Master calendar generated!');
}

function generateCalendarHTML(internsList) {
const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const colors = ['#e3f2fd','#f3e5f5','#e8f5e9','#fff3e0','#fce4ec','#e0f2f1','#f1f8e9','#fff9c4','#ede7f6','#e8eaf6','#ffebee','#f3e5f5','#e1f5fe','#fce4ec','#f9fbe7','#e0f7fa','#fef9e7','#f1f8e9','#ffe0b2'];

let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Posting Calendar</title>
<style>
body { font-family: Arial; padding: 20px; }
h1, h2 { text-align: center; color: #2c3e50; }
table { width: 100%; border-collapse: collapse; margin: 20px 0; }
th, td { border: 1px solid #ddd; padding: 10px; text-align: center; vertical-align: top; }
th { background: #3498db; color: white; }
.posting-cell { background: #e3f2fd; padding: 4px; margin: 2px 0; border-radius: 3px; font-size: 0.8em; }
</style></head><body>
<h1>JAIN AGM AYURVEDIC MEDICAL COLLEGE & HOSPITAL</h1>
<h2>POSTING CALENDAR</h2>
<p style="text-align: center; color: #7f8c8d;">Generated: ${new Date().toLocaleDateString('en-GB')}</p>`;

internsList.forEach(intern => {
const years = [...new Set(intern.postings.flatMap(p => [
new Date(p.fromDate).getFullYear(),
new Date(p.toDate).getFullYear()
]))].sort();

html += `
<div style="margin: 30px 0;">
<h3 style="background: #3498db; color: white; padding: 15px; border-radius: 8px;">
${intern.name} (${intern.regNo}) - Start: ${new Date(intern.startDate).toLocaleDateString('en-GB')}
</h3>`;

years.forEach(year => {
html += `<h4>Year ${year}</h4><table><thead><tr>${months.map(m => `<th>${m}</th>`).join('')}</tr></thead><tbody><tr>`;

months.forEach((m, mi) => {
let cellContent = '';
intern.postings.forEach((p, pi) => {
const start = new Date(p.fromDate);
const end = new Date(p.toDate);
const monthStart = new Date(year, mi, 1);
const monthEnd = new Date(year, mi + 1, 0);

if (start <= monthEnd && end >= monthStart) {
const dept = departments.find(d => d.name === p.department);
const code = dept ? dept.code : 'N/A';
const color = colors[pi % colors.length];
const fromDay = start.getMonth() === mi && start.getFullYear() === year ? start.getDate() : 1;
const toDay = end.getMonth() === mi && end.getFullYear() === year ? end.getDate() : monthEnd.getDate();

cellContent += `<div class="posting-cell" style="background: ${color};"><strong>${code}</strong><br>${fromDay}-${toDay}</div>`;
}
});

html += `<td style="height: 100px;">${cellContent || '-'}</td>`;
});

html += '</tr></tbody></table>';
});

html += '</div>';
});

html += `
<div style="text-align: center; margin-top: 30px; padding: 20px; background: #ecf0f1; border-radius: 10px;">
<p style="font-weight: bold;">OFFICIAL DOCUMENT</p>
</div>
</body></html>`;

return html;
}

function showDepartmentLetterModal(internId) {
const intern = interns.find(i => i.id === internId);
if (!intern || !intern.postings.length) {
alert('‚ö†Ô∏è No postings found');
return;
}

currentInternForDeptLetter = intern;
document.getElementById('departmentLetterInternInfo').innerHTML = `
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
<div><strong>Intern Name:</strong> ${intern.name}</div>
<div><strong>Registration No:</strong> ${intern.regNo}</div>
<div><strong>Start Date:</strong> ${new Date(intern.startDate).toLocaleDateString('en-GB')}</div>
<div><strong>Total Postings:</strong> ${intern.postings.length} departments</div>
</div>
`;

const select = document.getElementById('departmentLetterSelect');
select.innerHTML = '<option value="">-- Select a Department --</option>';

intern.postings.forEach((posting, index) => {
const dept = departments.find(d => d.name === posting.department);
const option = document.createElement('option');
option.value = index;
option.textContent = `${posting.department} (${dept ? dept.code : 'N/A'}) - ${new Date(posting.fromDate).toLocaleDateString('en-GB')} to ${new Date(posting.toDate).toLocaleDateString('en-GB')} [${posting.days} days]`;
select.appendChild(option);
});

document.getElementById('departmentLetterPreview').style.display = 'none';
document.getElementById('generateDeptLetterBtn').disabled = true;
document.getElementById('departmentLetterModal').style.display = 'block';
}

function updateDepartmentLetterPreview() {
const select = document.getElementById('departmentLetterSelect');
const selectedIndex = select.value;

if (selectedIndex === '') {
document.getElementById('departmentLetterPreview').style.display = 'none';
document.getElementById('generateDeptLetterBtn').disabled = true;
return;
}

const posting = currentInternForDeptLetter.postings[selectedIndex];
const dept = departments.find(d => d.name === posting.department);

let previewHTML = `
<h4 style="color: #2c3e50; margin-bottom: 15px;">üìã Letter Preview</h4>
<div style="background: white; padding: 15px; border-left: 4px solid #3498db;">
<p><strong>Department:</strong> ${posting.department}</p>
<p><strong>Code:</strong> ${dept ? dept.code : 'N/A'}</p>
<p><strong>Duration:</strong> ${new Date(posting.fromDate).toLocaleDateString('en-GB')} to ${new Date(posting.toDate).toLocaleDateString('en-GB')}</p>
<p><strong>Days:</strong> ${posting.days} days</p>
</div>
`;

document.getElementById('departmentLetterPreview').innerHTML = previewHTML;
document.getElementById('departmentLetterPreview').style.display = 'block';
document.getElementById('generateDeptLetterBtn').disabled = false;
}

function generateDepartmentLetter() {
const select = document.getElementById('departmentLetterSelect');
const selectedIndex = select.value;

if (selectedIndex === '' || !currentInternForDeptLetter) {
alert('‚ö†Ô∏è Please select a department');
return;
}

const posting = currentInternForDeptLetter.postings[selectedIndex];
const html = generateDepartmentLetterHTML(currentInternForDeptLetter, posting);
const filename = `${posting.department.replace(/\s+/g, '_')}_Letter_${currentInternForDeptLetter.name.replace(/\s/g, '_')}.html`;

downloadFile(html, filename);
alert(`‚úÖ Department letter generated!`);
closeModal('departmentLetterModal');
}

function generateDepartmentLetterHTML(intern, posting) {
const dept = departments.find(d => d.name === posting.department);

let html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>Department Posting Letter - ${posting.department}</title>
<style>
body { font-family: 'Times New Roman', serif; padding: 40px; line-height: 1.6; }
.letterhead { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2c3e50; padding-bottom: 20px; }
.letterhead h1 { color: #2c3e50; font-size: 1.8em; margin: 10px 0; }
.ref-date { display: flex; justify-content: space-between; margin: 20px 0; font-weight: bold; }
.subject { text-align: center; font-weight: bold; margin: 20px 0; text-decoration: underline; }
.content { margin: 20px 0; text-align: justify; }
.posting-box { background: #e3f2fd; border: 2px solid #3498db; padding: 20px; border-radius: 8px; margin: 20px 0; }
.posting-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0; }
.detail-item { background: white; padding: 10px; border-radius: 5px; }
.signature { margin-top: 60px; }
@media print { body { padding: 20px; } }
</style></head><body>
<div class="letterhead">
<h1>JAIN AGM AYURVEDIC MEDICAL COLLEGE & HOSPITAL</h1>
<p>VARUR, KALABURAGI DISTRICT, KARNATAKA</p>
<p>Affiliated to Rajiv Gandhi University of Health Sciences, Karnataka</p>
</div>

<div class="ref-date">
<div>Ref No: JAIN-AGM/INTERN/${new Date().getFullYear()}/${intern.regNo}/${dept ? dept.code : 'DEPT'}</div>
<div>Date: ${new Date().toLocaleDateString('en-GB')}</div>
</div>

<div class="content">
<p><strong>To,</strong><br>
<strong>${intern.name}</strong><br>
Registration Number: <strong>${intern.regNo}</strong><br>
Intern, BAMS Final Year</p>
</div>

<div class="subject">
DEPARTMENT POSTING ORDER - ${posting.department}
</div>

<div class="content">
<p>Dear ${intern.name.split(' ')[0]},</p>
<p>This is to inform you that you have been posted to the <strong>${posting.department}</strong> for your rotatory internship training as per the approved internship schedule.</p>
</div>

<div class="posting-box">
<h3 style="text-align: center; margin: 0 0 15px 0;">üìã POSTING DETAILS</h3>
<div class="posting-details">
<div class="detail-item">
<span style="font-weight: bold;">Department:</span><br>
${posting.department}
</div>
<div class="detail-item">
<span style="font-weight: bold;">Department Code:</span><br>
${dept ? dept.code : 'N/A'}
</div>
<div class="detail-item">
<span style="font-weight: bold;">From Date:</span><br>
${new Date(posting.fromDate).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
</div>
<div class="detail-item">
<span style="font-weight: bold;">To Date:</span><br>
${new Date(posting.toDate).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
</div>
<div class="detail-item">
<span style="font-weight: bold;">Total Duration:</span><br>
${posting.days} days
</div>
<div class="detail-item">
<span style="font-weight: bold;">Reporting Time:</span><br>
9:00 AM on the first day
</div>
</div>
</div>

<div class="content">
<p style="margin-top: 20px;"><strong>REPORTING INSTRUCTIONS:</strong></p>
<ol style="margin: 10px 0 10px 20px;">
<li>Report to the ${posting.department} on <strong>${new Date(posting.fromDate).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</strong> at 9:00 AM sharp</li>
<li>Carry this posting letter, your log book, and identity card</li>
<li>Meet with the HOD or department coordinator for orientation</li>
<li>Obtain your duty schedule and posting guidelines from the department</li>
</ol>

<p style="margin-top: 20px;">This posting is an integral part of your internship training program. Your active participation and dedication will ensure maximum learning and skill development.</p>
<p style="margin-top: 15px;">For any queries, please contact the Medical Superintendent Office.</p>
</div>

<div class="signature">
<p><strong>For Jain AGM Ayurvedic Medical College & Hospital</strong></p>
<br><br>
<p>_______________________________</p>
<p><strong>Medical Superintendent</strong></p>
<br>
<p style="margin-top: 20px;">_______________________________</p>
<p><strong>Head of Department</strong></p>
<p>${posting.department}</p>
</div>

<div style="text-align: center; margin-top: 40px; padding: 20px; background: #ecf0f1; border-radius: 10px;">
<p style="font-weight: bold;">OFFICIAL POSTING ORDER</p>
<p style="margin-top: 10px;">Posting Duration: ${new Date(posting.fromDate).toLocaleDateString('en-GB')} to ${new Date(posting.toDate).toLocaleDateString('en-GB')} (${posting.days} days)</p>
</div>
</body></html>`;

return html;
}

function deleteIntern(id) {
if (confirm('üóëÔ∏è Delete this intern and all postings?')) {
interns = interns.filter(i => i.id !== id);
localStorage.setItem('internData', JSON.stringify(interns));
updateStats();
renderInterns();
alert('‚úÖ Intern deleted');
}
}

function exportAllData() {
const data = {
interns,
exported: new Date().toISOString(),
version: '3.1',
college: 'JAIN AGM AYURVEDIC MEDICAL COLLEGE & HOSPITAL, VARUR'
};

const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `Intern_Data_Backup_${new Date().toISOString().split('T')[0]}.json`;
a.click();
URL.revokeObjectURL(url);
alert('‚úÖ Data exported!');
}

function importData() {
document.getElementById('importFile').click();
}

function handleImport(event) {
const file = event.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = function(e) {
try {
const data = JSON.parse(e.target.result);
if (data.interns && Array.isArray(data.interns)) {
if (confirm(`üì• Import ${data.interns.length} interns? This will replace current data.`)) {
interns = data.interns;
localStorage.setItem('internData', JSON.stringify(interns));
updateStats();
renderInterns();
alert('‚úÖ Data imported successfully!');
}
} else {
alert('‚ùå Invalid file format');
}
} catch (error) {
alert('‚ùå Error reading file');
}
};
reader.readAsText(file);
event.target.value = '';
}

function downloadFile(content, filename) {
const blob = new Blob([content], { type: 'text/html' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = filename;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
}

function updateStats() {
document.getElementById('totalInterns').textContent = interns.length;
document.getElementById('completedInterns').textContent = interns.filter(i => i.totalDays >= 365).length;
document.getElementById('pendingInterns').textContent = interns.filter(i => i.totalDays < 365).length;
}

function debugInterns() {
console.log('=== DEBUG INFO ===');
console.log('Total interns:', interns.length);
console.log('Departments:', departments.length);
console.log('In-house depts:', departments.filter(d => d.inHouse).length);
console.log('External depts:', departments.filter(d => !d.inHouse).length);
console.log('\nIntern details:');

interns.forEach((intern, i) => {
console.log(`\n${i+1}. ${intern.name} (${intern.regNo})`);
console.log(`  Start Date: ${intern.startDate}`);
console.log(`  Resume Date: ${intern.resumeFromDate || 'N/A'}`);
console.log(`  Completed Days: ${intern.completedDays || 0}`);
console.log(`  Postings: ${intern.postings.length}`);
console.log(`  Total Days: ${intern.totalDays}`);
console.log(`  Excluded: ${intern.excludedDepts ? intern.excludedDepts.length : 0}`);
console.log(`  Partial: ${intern.partialDepts ? Object.keys(intern.partialDepts).length : 0}`);
});

alert(`Debug info logged to console (Press F12)\n\nSummary:\n‚Ä¢ Total Interns: ${interns.length}\n‚Ä¢ Departments: ${departments.length}\n‚Ä¢ In-house: ${departments.filter(d => d.inHouse).length}\n‚Ä¢ External: ${departments.filter(d => !d.inHouse).length}`);
}

function closeModal(id) {
document.getElementById(id).style.display = 'none';
}

window.onclick = e => {
if (e.target.className === 'modal') e.target.style.display = 'none';
};

// Initialize
updateStats();
</script>
</body>
</html>
